<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8 />
    <title>Population cluster for electrification in Nigeria</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin="" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" integrity="sha384-X7L1bhgb36bF1iFvaqvhgpaGpayKM+vXNNYRlF89BFA5s3vi1qZ8EX9086RlZjy1" crossorigin="" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.css" integrity="sha384-lPzjPsFQL6te2x+VxmV6q1DpRxpRk0tmnl2cpwAO5y04ESyc752tnEWPKDfl1olr" crossorigin="" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.Default.css" integrity="sha384-5kMSQJ6S4Qj5i09mtMNrWpSi8iXw230pKU76xTmrpezGnNJQzj0NzXjQLLg+jE7k" crossorigin="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/11.0.3/nouislider.min.css" integrity="sha384-FkoYQ3TJKbULb445cDwfaUqQaTntabe5j49blZqESH0tMC1UexckavWD1M68+Y9B" crossorigin="" />
    <link rel="stylesheet" href="css/styles.css" />
</head>

<body>

      <div id="map" class="split right"></div>
      <div id="sidebar" class="split left">
        <div class="row">
          <div class="column level">
            <p> national </p>
          </div>
          <div class="column level">
            <p> state </p>
          </div>
        </div>
        <div id="village" class="level">
          <p> village </p>
        </div>
        <div id="layers" class="layers">
          <p> LAYERS </p>
        </div>
        <div id="states" class="layer">
          <p> States </p>
        </div>
        <div id="building_density" class="layer">
          <p> Building Density </p>
        </div>
        <div id="clusters" class="layer">
          <p> Clusters </p>
        </div>
        <div id="grid" class="layer">
          <p> Grid </p>
        </div>
      </div>


		<script src="https://cdn.polyfill.io/v2/polyfill.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.3.0/dist/leaflet.markercluster-src.js" integrity="sha384-NAOEbWFcjnXc7U9GkULPhupHZNAbqru9dS3c+4ANYAwtFoVAWuVuMVDH0DIy4ESp" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.vectorgrid@1.3.0/dist/Leaflet.VectorGrid.bundled.js" integrity="sha384-FON5fTjCTtPuBgUS1r2H/PGXstH0Rk23YKjZmB6qITkbFqBcqtey/rPo9eXwOWpx" crossorigin=""></script>
    <!-- <script src="data/points.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-sidebar-v2@3.0.2/js/leaflet-sidebar.min.js" integrity="sha384-LzTQ6yhqVy/ipjMq5MMk98mo0E64Wtu9K1Jm5OeKPolnqrlv3FMdc457RoOANGMb" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wnumb/1.1.0/wNumb.min.js" integrity="sha384-9NhfMwMkkA6dDFEyj5CxOiYaL6KqLjKINTJkR7e5SlZthrndR9oB/SJsi5PBNnjw" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/11.0.3/nouislider.min.js" integrity="sha384-sxnhs+25aQQN+rABTQEEYOIX5CW20SBJyXt9oGMT5VDacFTTWGXKotTEAe8BUiwb" crossorigin=""></script>

    <script>
        //Cluster filter for electrification data
        //(c) F. Zimmermann, 2018
        //Licensed under BSD 3-Clause

        let options = {
                center: [9, 7],
                zoom: 7,
                minZoom: 6,
                maxZoom: 15,
                zoomControl: false,
                maxBounds: [
                    [2, 15],
                    [14, 0]
                ]
            };
        let map = L.map("map", options);

        L.control.zoom({
            position: "topright"
        }).addTo(map);

        let osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        let topo = L.tileLayer("http://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: '&copy; <a href="https://opentopomap.org">OpenTopoMap</a>'
        });

        let nl = L.tileLayer("https://map1.vis.earthdata.nasa.gov/wmts-webmerc/VIIRS_CityLights_2012/default/{time}/{tilematrixset}{maxZoom}/{z}/{y}/{x}.{format}", {
            attribution: 'Imagery provided by services from the Global Imagery Browse Services (GIBS), operated by the NASA/GSFC/Earth Science Data and Information System (<a href="https://earthdata.nasa.gov">ESDIS</a>) with funding provided by NASA/HQ.',
            minZoom: 1,
            maxZoom: 8,
            format: "jpg",
            time: "",
            tilematrixset: "GoogleMapsCompatible_Level"
        });

        let ae = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        L.control.scale({
            position: "bottomright"
        }).addTo(map);

        let baseMaps = {
            "OpenStreetMap": osm,
            "OpenTopoMap": topo,
            "Night Lights": nl,
            "Aerial Imagery": ae
        };

        let vecTileLayer = L.vectorGrid.protobuf("https://tile.rl-institut.de/data/nesp/{z}/{x}/{y}.pbf", {
                rendererFactory: L.canvas.tile,
                vectorTileLayerStyles: {
                    ng_cluster_attr: function(prop, zoom) {
                        if (prop.FID > 0) {
                            color = "red";
                        } else {
                            color = "lightgrey";
                        }
                        return {
                            fill: true,
                            fillColor: color,
                            fillOpacity: 0.2,
                            color: "red",
                            weight: 1
                        };
                    },
                    regions: function(prop, zoom) {
                        if (zoom > 7) {
                            return {
                                stroke: false
                            };
                        } else {
                            return {
                                color: "LightGreen",
                                weight: 5,
                                opacity: 0.3
                            };
                        }
                    },
                    kedco_lines: {
                        color: "#ff7800",
                        weight: 2,
                        opacity: 0.85,
                        smoothFactor: 5
                    }
                },
                maxZoom: 15,
                minZoom: 5,
                interactive: true,
                getFeatureId: function(f) {
                    if (f.properties.FID !== undefined) {
                        return f.properties.FID;
                    }
                    if (f.properties.osm_id !== undefined) {
                        return "g" + f.properties.osm_id;
                    }
                    return "r" + f.properties.OBJECTID;
                }
            })
            .on("click", function(e) {
                console.log('click')
                this.clearHighlight();
                let properties = e.layer.properties;
                console.log(properties)
                if (properties.FID !== undefined) {
                    var type = "c";
                    var ID = properties.FID;
                    var popup='\
                    <table>\
                      <tr><td align="right"><b>Admin1</b>:</td><td>'+properties.admin1+'</td></tr>\
                      <tr><td align="right"><b>Admin2</b>:</td><td>'+properties.admin2+'</td></tr>\
                      <tr><td align="right"><b>Area</b>:</td><td>'+parseFloat(properties.area_km2).toFixed(2)+' km2</td></tr>\
                      <tr><td align="right"><b>Population</b>:</td><td>'+parseFloat(properties.pop_hrsl).toFixed(0)+'</td></tr>\
                    </table>';
                } else if (properties.osm_id !== undefined) {
                    var type = "g";
                    var ID = "g" + properties.osm_id;
                    var popup = '\
                                <b>Voltage</b>: '+properties.voltage+' kV <br/>\
                                <b>Operator</b>: '+properties.operator+'<br/>\
                                ';
                } else {
                    var type = "r";
                    var ID = "r" + properties.OBJECTID;
                }
                if (type != "r") {
                    L.popup()
                        .setContent(popup)
                        .setLatLng(e.latlng)
                        .openOn(map);
                    this.highlight = ID;
                    let style = {
                        fillColor: "#0000FF",
                        fillOpacity: 0.5,
                        stroke: true,
                        fill: true,
                        color: "#0000FF",
                        opacity: 0.5,
                        weight: 2
                    };

                    this.setFeatureStyle(ID, style);
                    L.DomEvent.stop(e);
                }
            });
        vecTileLayer.highlight = null;
        vecTileLayer.hidden = null;
        vecTileLayer.hiddenstyle = {
            fillColor: "lightgray",
            fillOpacity: 0.3,
            opacity: 0,
            fill: true,
            color: "lightgray"
        };
        vecTileLayer.clearHidden = function() {
            if (this.hiddenIDs) {
                for (let i = 0, len = this.hiddenIDs.length; i < len; i++) {
                    let id = this.hiddenIDs[i];
                    this.resetFeatureStyle(id);
                }
            }
        };
        vecTileLayer.clearHighlight = function() {
            if (this.highlight) {
                if (this.hiddenIDs && this.hiddenIDs.indexOf(this.highlight) > -1){
                    this.setFeatureStyle(this.highlight, this.hiddenstyle);
                } else {
                    this.resetFeatureStyle(this.highlight);
                }
            }
            this.highlight = null;
        };

        map.addLayer(vecTileLayer);
        map.on("click", function() {
            vecTileLayer.clearHighlight();
        });
        map.on("popupclose", function() {
            vecTileLayer.clearHighlight();
        });

        // const AREA = 0,POP = 1,LONG = 3,LAT = 4,INFO = 5;
        let currentfilter = {
            minarea: 0.001,
            maxarea: 100,
            minpop: 1,
            maxpop: 1000000,
        };

        vecTileLayer.filter = function(filter) {
            let newhiddenIDs = [];
            let vt = this._vectorTiles;
            for (let vtkey in vt) {
                let f = vt[vtkey]._features;
                for (let fkey in f) {
                    
                    let prop = f[fkey].feature.properties;
                    if (typeof prop.area_km2 !== 'undefined'){
                        if (!(prop.area_km2 > filter.minarea && prop.area_km2 < filter.maxarea && prop.pop_hrsl > filter.minpop && prop.pop_hrsl < filter.maxpop)) {
                            newhiddenIDs.push(prop.FID);
                            if (this.hiddenIDs.indexOf(prop.FID) == -1){
                                this.setFeatureStyle(prop.FID, this.hiddenstyle);
                            }
                        } else if (this.hiddenIDs.indexOf(prop.FID) > -1){
                            this.resetFeatureStyle(prop.FID);
                        }
                    }
                }
            }
            this.hiddenIDs = newhiddenIDs;
        };

        map.addEventListener("filterchange", function(filter) {
            vecTileLayer.filter(currentfilter);
            // markers.filter(currentfilter, map);
        });

        vecTileLayer.on("load", function(e) {
            vecTileLayer.filter(currentfilter);
        });
        let logFormat = function(decimals){
            return wNumb({
                decimals: decimals,
                thousand: ",",
                encoder: function(val){
                    return Math.pow(10,val);
                },
                decoder: function(val){
                    return Math.log10(val);
                }
            })
        };

        noUiSlider.create(sliderarea, {
            start: [currentfilter.minarea, currentfilter.maxarea],
            connect: true,
            range: {
                "min": Math.log10(currentfilter.minarea),
                "max": Math.log10(currentfilter.maxarea)
            },
            format: logFormat(2),
            tooltips: true,
            pips: {
                format: logFormat(2),
                mode: "count",
                values: Math.log10(currentfilter.maxarea)-Math.log10(currentfilter.minarea)+1,
                density: 100
            }
        });
        sliderarea.noUiSlider.on("change", function(str, h, values) {
            currentfilter.minarea = Math.pow(10,values[0]);
            currentfilter.maxarea = Math.pow(10,values[1]);
            map.fireEvent("filterchange", currentfilter);
        });

        let overlayMaps = {
            // "Priority Clusters": markers
        };
        L.control.layers(baseMaps, overlayMaps).addTo(map);
        map.on("layeradd",function (){vecTileLayer.bringToFront();});
        map.fireEvent("filterchange", currentfilter);

    </script>
</body>

</html>
